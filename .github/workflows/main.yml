name: Deploy to VPS (frontend + dev + nginx)

on:
  push:
    branches:
      - '**' 

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MINIAPP_KEY }}

      - name: Add SSH host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 45.9.40.96 >> ~/.ssh/known_hosts

      - name: ðŸš€ SSH into server and deploy
        run: |
          BRANCH=${{ github.ref_name }}

          ssh root@45.9.40.96 << EOF
            set -e

            echo "ðŸ›‘ Pull latest code for PROD..."
            cd /root/miniApp
            docker compose down
            git fetch origin
            git checkout main
            git pull origin main

            echo "ðŸ›‘ Pull latest code for DEV..."
            cd /root/miniApp_dev
            git fetch origin
            git checkout -B $BRANCH origin/$BRANCH
            git pull 

            echo "ðŸ›‘ Building and starting all containers..."
            cd /root
            
            docker system prune --volumes -f
            docker builder prune -f
            docker system prune -f
            docker compose build --no-cache
            docker compose up -d

            echo "âœ… Deployment finished!"
          EOF
